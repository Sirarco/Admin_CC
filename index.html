<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin QA - HLF</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Navbar State */
        .nav-btn { opacity: 0.6; transition: all 0.3s; border-bottom: 2px solid transparent; }
        .nav-btn:hover { opacity: 1; background-color: rgba(255,255,255,0.1); }
        .active-tab { opacity: 1 !important; font-weight: 700; border-bottom: 2px solid #34d399; background-color: rgba(255,255,255,0.15); }

        /* Tooltips */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: help; }
        .tooltip-text { 
            visibility: hidden; width: 220px; background-color: #1f293b; color: #fff; text-align: left;
            border-radius: 6px; padding: 10px; position: absolute; z-index: 100; 
            bottom: 130%; left: 0; 
            opacity: 0; transition: opacity 0.2s; font-size: 11px; font-weight: normal; line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* DOCKS FLOTANTES (AGRANDADOS 25%) */
        .dock-panel { 
            transition: all 0.3s ease; 
            backdrop-filter: blur(10px); 
            /* Escala aumentada 1.15 (aprox 25% area visual percibida mas grande) */
            transform: scale(1.15); 
        }
        
        .dock-left { origin: top left; }
        .dock-right { origin: top right; }

        .counter-row { @apply flex justify-between items-center border-b border-gray-200/50 pb-2 mb-2 last:border-0 last:mb-0 last:pb-0; }

        /* MODO OSCURO */
        body.dark-mode { background-color: #0f172a; color: #e2e8f0; }
        body.dark-mode .bg-white { background-color: #1e293b; color: #e2e8f0; border-color: #334155; }
        body.dark-mode .bg-slate-50 { background-color: #334155; color: #e2e8f0; border-color: #475569; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background-color: #0f172a; color: #fff; border-color: #475569; }
        body.dark-mode table thead { background-color: #0f172a; color: #94a3b8; }
        body.dark-mode .shadow-md, body.dark-mode .shadow-lg { box-shadow: none; border: 1px solid #334155; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #10b981; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-slate-50 relative" id="mainBody">

    <div id="audioDock" class="dock-panel fixed left-8 top-24 w-72 bg-white/95 border border-slate-200 shadow-2xl rounded-xl z-[60] flex flex-col transform origin-top-left hidden">
        <div class="bg-indigo-900 text-white p-3 rounded-t-xl flex justify-between items-center cursor-move">
            <span class="text-xs font-bold uppercase tracking-wider"><i class="fas fa-headphones mr-2"></i>Player QA</span>
            <button onclick="toggleDock('audioDock','openAudioBtn')" class="hover:text-indigo-300"><i class="fas fa-minus"></i></button>
        </div>
        <div class="p-4 bg-slate-50 rounded-b-xl border-t border-slate-100">
            <div class="mb-3 text-center">
                <audio id="mainAudioPlayer" controls class="w-full h-10 mb-2"></audio>
                <div id="audioStatus" class="text-[10px] text-slate-400 font-bold uppercase mb-2">Esperando Link...</div>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setSpeed(1.0)" class="speed-btn bg-slate-200 text-slate-600 py-1.5 rounded text-xs font-bold hover:bg-indigo-100 hover:text-indigo-600 transition">1.0x</button>
                <button onclick="setSpeed(1.5)" class="speed-btn bg-slate-200 text-slate-600 py-1.5 rounded text-xs font-bold hover:bg-indigo-100 hover:text-indigo-600 transition">1.5x</button>
                <button onclick="setSpeed(2.0)" class="speed-btn bg-slate-200 text-slate-600 py-1.5 rounded text-xs font-bold hover:bg-indigo-100 hover:text-indigo-600 transition">2.0x</button>
            </div>
        </div>
    </div>
    <button id="openAudioBtn" onclick="toggleDock('audioDock','openAudioBtn')" class="fixed left-0 top-32 bg-indigo-900 text-white p-3 rounded-r-lg shadow-lg z-50 hover:bg-indigo-800 transition hidden"><i class="fas fa-chevron-right"></i></button>


    <div id="auditTools" class="dock-panel fixed right-8 top-24 w-72 bg-white/95 border border-slate-200 shadow-2xl rounded-xl z-[60] flex flex-col hidden transform origin-top-right">
        <div id="dockHeader" class="bg-slate-800 text-white p-3 rounded-t-xl flex justify-between items-center cursor-move">
            <span class="text-xs font-bold uppercase tracking-wider"><i class="fas fa-tools mr-2"></i>Herramientas</span>
            <button onclick="toggleDock('auditTools','openToolsBtn')" class="hover:text-emerald-400"><i class="fas fa-minus"></i></button>
        </div>
        
        <div id="toolsBody" class="p-4 space-y-4 max-h-[80vh] overflow-y-auto">
            <div class="bg-slate-50 p-3 rounded border border-slate-200">
                <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Apariencia</p>
                <div class="flex gap-2 mb-2">
                    <button onclick="setTheme('slate')" class="w-6 h-6 rounded-full bg-slate-800 border-2 border-white shadow hover:scale-110 transition"></button>
                    <button onclick="setTheme('blue')" class="w-6 h-6 rounded-full bg-blue-700 border-2 border-white shadow hover:scale-110 transition"></button>
                    <button onclick="setTheme('emerald')" class="w-6 h-6 rounded-full bg-emerald-700 border-2 border-white shadow hover:scale-110 transition"></button>
                    <button onclick="setTheme('rose')" class="w-6 h-6 rounded-full bg-rose-700 border-2 border-white shadow hover:scale-110 transition"></button>
                </div>
                <button onclick="toggleDarkMode()" class="w-full bg-gray-700 text-white text-[10px] py-1.5 rounded hover:bg-gray-600 transition font-bold"><i class="fas fa-moon mr-1"></i> Modo Oscuro</button>
            </div>
            
            <div class="bg-slate-50 p-3 rounded border border-slate-200">
                <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Pegar Fecha Sistema</p>
                <div class="flex gap-1">
                    <input type="text" id="pasteDateInput" class="w-full text-xs p-1.5 border rounded" placeholder="Ej: 2026-01-28 13:48:52">
                    <button onclick="parseSystemDate()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700"><i class="fas fa-arrow-circle-right"></i></button>
                </div>
            </div>

            <div class="bg-slate-50 p-3 rounded border border-slate-200 text-center">
                <div class="text-3xl font-mono font-black text-slate-700 mb-2" id="timerDisplay">00:00</div>
                <div class="flex justify-center gap-2">
                    <button onclick="startTimer()" class="bg-emerald-500 text-white w-8 h-8 rounded hover:bg-emerald-600 flex items-center justify-center shadow"><i class="fas fa-play text-xs"></i></button>
                    <button onclick="pauseTimer()" class="bg-amber-400 text-white w-8 h-8 rounded hover:bg-amber-500 flex items-center justify-center shadow"><i class="fas fa-pause text-xs"></i></button>
                    <button onclick="resetTimer()" class="bg-slate-400 text-white w-8 h-8 rounded hover:bg-slate-500 flex items-center justify-center shadow"><i class="fas fa-undo text-xs"></i></button>
                </div>
            </div>

            <div class="bg-slate-50 p-3 rounded border border-slate-200">
                <div class="counter-row"><p class="text-[10px] font-bold uppercase">Muletillas</p><div class="flex items-center gap-2"><span class="font-black text-indigo-600 w-6 text-center text-sm" id="cntMuletillas">0</span><button onclick="countUp('cntMuletillas')" class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded font-bold text-xs">+</button><button onclick="countReset('cntMuletillas')" class="text-slate-300 hover:text-red-400"><i class="fas fa-times text-xs"></i></button></div></div>
                <div class="counter-row"><p class="text-[10px] font-bold uppercase">Personaliz.</p><div class="flex items-center gap-2"><span class="font-black text-emerald-600 w-6 text-center text-sm" id="cntPerso">0</span><button onclick="countUp('cntPerso')" class="bg-emerald-100 text-emerald-600 w-6 h-6 rounded font-bold text-xs">+</button><button onclick="countReset('cntPerso')" class="text-slate-300 hover:text-red-400"><i class="fas fa-times text-xs"></i></button></div></div>
                <div class="counter-row"><p class="text-[10px] font-bold uppercase">Otros</p><div class="flex items-center gap-2"><span class="font-black text-slate-600 w-6 text-center text-sm" id="cntOtros">0</span><button onclick="countUp('cntOtros')" class="bg-slate-200 text-slate-600 w-6 h-6 rounded font-bold text-xs">+</button><button onclick="countReset('cntOtros')" class="text-slate-300 hover:text-red-400"><i class="fas fa-times text-xs"></i></button></div></div>
            </div>

            <div class="bg-slate-50 p-3 rounded border border-slate-200">
                <div class="flex justify-between items-center mb-2"><p class="text-[10px] text-slate-400 font-bold uppercase">Notas</p><button onclick="copyNotes()" class="text-[10px] text-blue-600 hover:underline"><i class="fas fa-copy"></i></button></div>
                <textarea id="tempNotes" class="w-full h-24 text-xs p-2 border border-slate-300 rounded resize-none bg-white" placeholder="Escribe..."></textarea>
            </div>
        </div>
    </div>
    <button id="openToolsBtn" onclick="toggleDock('auditTools','openToolsBtn')" class="fixed right-0 top-32 bg-slate-800 text-white p-3 rounded-l-lg shadow-lg z-50 hover:bg-slate-700 transition hidden"><i class="fas fa-chevron-left"></i></button>

    <nav id="mainNav" class="bg-slate-900 text-white px-6 py-2 flex justify-between items-center shadow-md shrink-0 z-50 transition-colors duration-300">
        <div class="flex items-center gap-3">
            <div id="logoIcon" class="bg-white/20 w-8 h-8 rounded flex items-center justify-center text-white shadow-inner">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm tracking-wide leading-none">Admin QA</h1>
                <p class="text-[9px] opacity-70 uppercase tracking-widest">Panel de Control</p>
            </div>
        </div>
        <div class="flex gap-2 text-xs bg-black/20 p-1 rounded-lg">
            <button onclick="cambiarTab('tabIngreso')" id="navBtnIngreso" class="nav-btn active-tab px-4 py-1.5 rounded text-white">Auditar</button>
            <button onclick="cambiarTab('tabDashboard')" id="navBtnDash" class="nav-btn px-4 py-1.5 rounded text-white">Dashboard</button>
            <button onclick="cambiarTab('tabApelaciones')" id="navBtnApel" class="nav-btn px-4 py-1.5 rounded text-white">Apelaciones</button>
        </div>
    </nav>

    <div id="tabIngreso" class="flex-1 overflow-y-auto p-4">
        <div class="max-w-6xl mx-auto bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-bold text-gray-700 text-sm"><i class="fas fa-file-contract mr-2"></i>Nueva Auditor√≠a</h2>
                <span class="text-[10px] bg-white border border-gray-200 px-2 py-0.5 rounded text-gray-500 uppercase font-bold">Admin</span>
            </div>

            <form id="auditForm" class="p-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 bg-slate-50/50 p-3 rounded border border-slate-100">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-0.5">Fecha Llamada</label><input type="date" id="fechaLlamada" name="fecha_llamada" class="w-full border border-slate-300 rounded p-1.5 text-xs focus:ring-1 focus:ring-blue-500 outline-none" required onchange="calcSemana()"></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-0.5">Hora</label><input type="time" id="horaLlamada" name="hora_llamada" class="w-full border border-slate-300 rounded p-1.5 text-xs focus:ring-1 focus:ring-blue-500 outline-none" required></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-0.5">Semana</label><input type="text" id="inputSemana" name="semana" class="w-full bg-slate-100 border border-slate-300 rounded p-1.5 text-xs text-slate-500 cursor-not-allowed" readonly></div>
                    <div><label class="block text-[10px] font-bold text-blue-500 uppercase mb-0.5">RUT Paciente</label><input type="text" name="rut_paciente" class="w-full border border-slate-300 rounded p-1.5 text-xs font-bold" placeholder="12.345.678-9"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="md:col-span-2 relative">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-0.5">Ejecutivo</label>
                        <input type="text" id="inputNombre" name="nombre" list="lista-ejecutivos" class="w-full pl-2 border border-slate-300 rounded p-1.5 text-xs font-bold focus:ring-1 focus:ring-blue-500 outline-none uppercase" placeholder="Buscar..." autocomplete="off">
                        <datalist id="lista-ejecutivos"></datalist>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-0.5">Audio URL</label>
                        <div class="flex gap-1">
                            <input type="url" id="inputAudioUrl" name="audio_url" class="w-full border border-slate-300 rounded p-1.5 text-xs text-blue-600 font-mono" placeholder="https://...">
                            <button type="button" onclick="loadAudioFromForm()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 transition" title="Cargar en Player"><i class="fas fa-play text-xs"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 bg-slate-50 p-2 rounded border border-slate-100 text-[10px]">
                    <div><span class="font-bold text-slate-400 uppercase mr-1">C√≥d:</span><input id="inputCodigo" name="codigo" class="bg-transparent font-bold w-16" readonly></div>
                    <div><span class="font-bold text-slate-400 uppercase mr-1">Sup:</span><input id="inputSup" name="supervisor" class="bg-transparent font-bold w-32" readonly></div>
                    <div><span class="font-bold text-slate-400 uppercase mr-1">Serv:</span><input id="inputServ" name="servicio" class="bg-transparent font-bold w-32" readonly></div>
                </div>

                <div class="hidden"><input type="date" id="fechaAuditoria" name="fecha_auditoria"><input type="text" name="auditor_real" value="Admin Master"><input type="text" name="rut" value="N/A"></div>

                <div class="border border-slate-200 rounded overflow-hidden">
                    <table class="w-full text-[11px]">
                        <thead class="bg-slate-800 text-white uppercase tracking-wider text-[10px]">
                            <tr><th class="p-2 text-left">Indicador</th><th class="p-2 text-center w-20">Cumple</th><th class="p-2 text-center w-20">Estado</th><th class="p-2 text-left">Observaci√≥n</th></tr>
                        </thead>
                        <tbody id="tablaItems" class="divide-y divide-slate-100 bg-white"></tbody>
                        <tfoot class="bg-slate-50 border-t border-slate-200">
                            <tr><td colspan="2" class="p-3 text-right font-bold text-slate-500">NOTA FINAL:</td><td colspan="2" class="p-3 text-left"><div id="totalScore" class="font-black text-2xl text-slate-300 transition-all duration-300">0%</div></td></tr>
                        </tfoot>
                    </table>
                </div>
                <input type="hidden" name="nota_final" id="notaFinalHidden" value="0%">
                
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Comentarios</label>
                    <textarea name="comentario" id="mainComments" class="w-full border border-slate-300 rounded p-2 text-xs focus:ring-1 focus:ring-blue-500 outline-none h-16 resize-none" placeholder="Observaciones generales..."></textarea>
                </div>

                <button type="submit" id="btnGuardar" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded shadow transition flex justify-center items-center gap-2 text-xs tracking-widest uppercase"><i class="fas fa-save text-emerald-400"></i> Guardar Auditor√≠a</button>
            </form>
            
            <div class="mt-8 mb-4 text-center opacity-30 hover:opacity-100 transition-opacity duration-500">
                <p class="text-[9px] font-bold uppercase tracking-widest">Desarrollado por <span class="text-indigo-500">Tu Nombre</span></p>
                <a href="mailto:tuemail@ejemplo.com" class="text-[8px] hover:text-indigo-500">Soporte</a>
            </div>
        </div>
    </div>

    <div id="tabDashboard" class="hidden flex-1 overflow-y-auto p-6 bg-slate-100">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 sticky top-0 z-40">
            <div class="flex flex-wrap items-end gap-3">
                <div class="flex-1 min-w-[120px]"><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Periodo</label><select id="fMes" class="w-full border border-slate-200 p-2 rounded text-xs font-bold bg-slate-50 outline-none" onchange="aplicarFiltros()"><option value="TODOS">üìÖ Hist√≥rico</option></select></div>
                <div class="flex-1 min-w-[120px]"><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Supervisor</label><select id="fSup" class="w-full border border-slate-200 p-2 rounded text-xs bg-slate-50 outline-none" onchange="aplicarFiltros()"><option value="TODOS">Todos</option></select></div>
                <div class="flex-1 min-w-[120px]"><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Servicio</label><select id="fServ" class="w-full border border-slate-200 p-2 rounded text-xs bg-slate-50 outline-none" onchange="aplicarFiltros()"><option value="TODOS">Todos</option></select></div>
                <div class="flex-[2] min-w-[180px]"><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Ejecutivo</label><input type="text" id="fSearch" list="lista-filtro-dash" class="w-full pl-3 border border-slate-200 p-2 rounded text-xs font-bold bg-slate-50 outline-none uppercase" placeholder="Buscar..." oninput="aplicarFiltros()"><datalist id="lista-filtro-dash"></datalist></div>
                <div class="flex items-center gap-2">
                    <button onclick="loadData()" class="px-3 py-2 bg-blue-100 text-blue-600 rounded text-xs font-bold border border-blue-200 hover:bg-blue-200 transition" title="Recargar"><i class="fas fa-sync-alt"></i></button>
                    <button onclick="resetFiltros()" class="px-3 py-2 bg-slate-100 text-slate-500 rounded text-xs font-bold border border-slate-200 hover:bg-slate-200"><i class="fas fa-eraser"></i></button>
                    <button onclick="exportarExcel()" class="px-3 py-2 bg-emerald-600 text-white rounded text-xs font-bold hover:bg-emerald-700 shadow flex items-center gap-2"><i class="fas fa-file-excel"></i> Excel</button>
                </div>
                <div id="loadingIndicator" class="loader ml-2 hidden"></div>
            </div>
        </div>

        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 pl-1 tracking-widest">Rendimiento por L√≠der</h3>
        <div id="supervisorCards" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8"><div class="bg-slate-200 p-4 rounded-xl animate-pulse h-32"></div></div>

        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 pl-1 tracking-widest">M√©tricas Globales</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-6">
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-slate-500"><p class="text-[9px] text-slate-400 font-bold uppercase">Auditor√≠as</p><p class="text-xl font-black text-slate-700" id="kpiTotal">-</p></div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-emerald-500"><p class="text-[9px] text-emerald-600 font-bold uppercase truncate">Prom. PENC</p><p class="text-xl font-black text-emerald-600" id="kpiPenc">-</p></div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-indigo-600"><p class="text-[9px] text-indigo-600 font-bold uppercase truncate">Prom. General</p><p class="text-xl font-black text-indigo-700" id="kpiGeneral">-</p></div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-red-600"><p class="text-[9px] text-red-600 font-bold uppercase">Cant. PEC</p><p class="text-xl font-black text-red-600" id="kpiCountPec">-</p></div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-orange-400"><p class="text-[9px] text-orange-500 font-bold uppercase">Cant. PENC</p><p class="text-xl font-black text-orange-500" id="kpiCountPenc">-</p></div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-purple-500"><p class="text-[9px] text-purple-500 font-bold uppercase">Feedback</p><p class="text-xl font-black text-purple-600" id="kpiFeedback">-</p></div>
            <div class="bg-white p-3 rounded-lg shadow-sm border-b-4 border-pink-500"><p class="text-[9px] text-pink-500 font-bold uppercase">Apelaciones</p><p class="text-xl font-black text-pink-600" id="kpiApel">-</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden"><div class="bg-red-50 px-3 py-2 border-b border-red-100 font-bold text-[10px] text-red-700 uppercase flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> Top Cr√≠ticos (PEC)</div><ul id="listTopPec" class="p-3 space-y-2 text-xs"></ul></div>
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden"><div class="bg-orange-50 px-3 py-2 border-b border-orange-100 font-bold text-[10px] text-orange-700 uppercase flex items-center"><i class="fas fa-clipboard-list mr-2"></i> Top Leves (PENC)</div><ul id="listTopPenc" class="p-3 space-y-2 text-xs"></ul></div>
            </div>
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-xs"><i class="fas fa-users mr-2 text-slate-400"></i>Cobertura de Equipo</h3><span id="lblPeriodoCobertura" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold uppercase">Todo</span></div>
                    <div class="overflow-auto max-h-56"><table class="w-full text-xs text-left"><thead class="bg-slate-50 text-slate-500 uppercase font-bold sticky top-0 text-[10px]"><tr><th class="p-2 cursor-pointer" onclick="sortExecTable('NOMBRE')">Nombre</th><th class="p-2">Supervisor</th><th class="p-2">Servicio</th><th class="p-2 text-center cursor-pointer" onclick="sortExecTable('TOTAL')">Total Auditor√≠as</th></tr></thead><tbody id="execSummaryTable" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[400px]">
                    <div class="px-4 py-3 border-b border-slate-100"><h3 class="font-bold text-slate-700 text-xs"><i class="fas fa-list mr-2 text-slate-400"></i>Detalle de Evaluaciones</h3></div>
                    <div class="overflow-auto flex-1"><table class="w-full text-xs text-left"><thead class="bg-slate-50 text-slate-500 uppercase font-bold border-b border-slate-200 sticky top-0 z-10 text-[10px]"><tr><th class="p-2 cursor-pointer" onclick="sortTable('CODIGO')">C√≥d</th><th class="p-2 cursor-pointer" onclick="sortTable('NOMBRE')">Ejecutivo</th><th class="p-2">Sup</th><th class="p-2 cursor-pointer" onclick="sortTable('FECHA')">Fecha</th><th class="p-2">Sem</th><th class="p-2">Serv</th><th class="p-2 text-center cursor-pointer" onclick="sortTable('NOTA')">Nota</th><th class="p-2 text-center">Feedback</th><th class="p-2 text-center">Ver</th></tr></thead><tbody id="mainTable" class="divide-y divide-slate-100"></tbody></table></div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 mb-4 text-center opacity-30 hover:opacity-100 transition-opacity duration-500">
            <p class="text-[9px] font-bold uppercase tracking-widest">Desarrollado por <span class="text-indigo-500">Tu Nombre</span></p>
            <a href="mailto:tuemail@ejemplo.com" class="text-[8px] hover:text-indigo-500">Soporte</a>
        </div>
    </div>

    <div id="tabApelaciones" class="hidden flex-1 overflow-y-auto p-6 bg-slate-100">
        <div class="max-w-5xl mx-auto"><h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-gavel text-pink-500 mr-2"></i> Gesti√≥n de Apelaciones</h2><div id="contApelaciones" class="grid grid-cols-1 gap-4"><p class="text-center text-slate-400 py-10 italic">Cargando...</p></div></div>
    </div>
<script>
        // ================= CONFIGURACI√ìN =================
        const API_URL = "https://script.google.com/macros/s/AKfycbzGtnjzJeHSePkZ_0k_bt1hZcrYVjxIcV4_dekezLO815n7YPUlmCbt5QmvmwYcqyYheA/exec"; 

        const baseEjecutivos = [
            {nombre:"Andreina Villalon Mej√≠as", codigo:"CC1683", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Oscar Hidalgo Luco", codigo:"CC9827", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Lorena Rodriguez Salazar", codigo:"CC4346", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Angelica Galleguillos Abarca", codigo:"CC5251", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Miriam Bruges De Torres", codigo:"CC0928", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Cristobal Fernandez Azares", codigo:"CC0315", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Carla Garay Vidal", codigo:"CC5070", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Jorge Yanez Cort√©s", codigo:"CC2467", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Maria Paz Nu√±ez Baeza", codigo:"CC5178", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Diego Cea Brice√±o", codigo:"CC7625", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Edith Ossandon Montoya", codigo:"CC2762", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Johanna Herrera Merida", codigo:"CC7119", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Lesli Agudelo Viveros", codigo:"CC3118", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Maria Cristina Bar√≥n Bar√≥n", codigo:"CC1815", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Yessenia Gonzalez Gonz√°lez", codigo:"CC6869", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Paola Herrera Barriga", codigo:"CC3898", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Adrian Manzanilla Rangel", codigo:"CC0506", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Mar√≠a Far√≠as Quintero", codigo:"CC0851", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Saymar Pa√©z Garc√≠a", codigo:"CC1992", sup:"Aracely Torres", serv:"FDS"},
            {nombre:"Katya C√°ceres Gonz√°lez", codigo:"CC1225", sup:"Aracely Torres", serv:"FDS"},
            {nombre:"Belfred Belis Mijares", codigo:"CC8219", sup:"Aracely Torres", serv:"FDS"},
            {nombre:"Carla Cabrera Lara", codigo:"S5388", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Aracely Torres Fa√∫ndez", codigo:"S7637", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Luis Cataldo Galaz", codigo:"S2065", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Mar√≠a Ang√©lica Ferrada Cea", codigo:"S7705", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Marco Lara Vera", codigo:"S0226", sup:"Aracely Torres", serv:"HLF"}
        ];

        // DICCIONARIO MAESTRO DE INDICADORES (Traducci√≥n Excel -> Nombre Pauta)
        const INDICADORES_MAP = {
            "SEG_VALIDACION": "Validaci√≥n Identidad",
            "SEG_CONFIDENCIALIDAD": "Confidencialidad",
            "COND_NORMAS": "Normas de Conducta",
            "OP_ABANDONO": "Abandono",
            "SIST_REGISTRO": "Registro",
            "PROT_SCRIPT": "Script Inicio/Cierre",
            "PROT_CORTESIA": "Cortes√≠a y Trato",
            "GEST_SONDEO": "Sondeo",
            "GEST_INFORMACION": "Entrega Informaci√≥n",
            "GEST_TIEMPOS": "Manejo Tiempos",
            "GEST_ASEGURAMIENTO": "Aseguramiento",
            "HAB_PERSONALIZACION": "Personalizaci√≥n",
            "HAB_LENGUAJE": "Lenguaje",
            "HAB_EMPATIA": "Empat√≠a",
            "SIST_TIPIFICACION": "Tipificaci√≥n"
        };

        const pautaItems = [
            {cat:"PEC", label:"Validaci√≥n Identidad", name:"item_validacion", tip:"Solicita RUT y Nombre completo."},
            {cat:"PEC", label:"Confidencialidad", name:"item_confidencialidad", tip:"Resguardo de datos sensibles."},
            {cat:"PEC", label:"Normas de Conducta", name:"item_normas", tip:"No grita, no corta llamada."},
            {cat:"PEC", label:"Abandono", name:"item_abandono", tip:"No deja en mudo excesivo."},
            {cat:"PEC", label:"Registro", name:"item_registro", tip:"Deja nota o glosa."},
            {cat:"PENC", label:"Script Inicio/Cierre (5%)", name:"item_script", w:5, tip:"Saludo institucional y despedida."},
            {cat:"PENC", label:"Cortes√≠a y Trato (5%)", name:"item_cortesia", w:5, tip:"Usa 'Usted', por favor, gracias."},
            {cat:"PENC", label:"Sondeo (15%)", name:"item_sondeo", w:15, tip:"Preguntas correctas."},
            {cat:"PENC", label:"Entrega Informaci√≥n (20%)", name:"item_info", w:20, tip:"Info correcta y completa."},
            {cat:"PENC", label:"Manejo Tiempos (10%)", name:"item_tiempos", w:10, tip:"Retoma cada 45 segs."},
            {cat:"PENC", label:"Aseguramiento (10%)", name:"item_aseguramiento", w:10, tip:"Valida entendimiento."},
            {cat:"PENC", label:"Personalizaci√≥n (5%)", name:"item_personalizacion", w:5, tip:"Usa el nombre del paciente."},
            {cat:"PENC", label:"Lenguaje (5%)", name:"item_lenguaje", w:5, tip:"Modulaci√≥n clara."},
            {cat:"PENC", label:"Empat√≠a (10%)", name:"item_empatia", w:10, tip:"Conecta emocionalmente."},
            {cat:"PENC", label:"Tipificaci√≥n (15%)", name:"item_tipificacion", w:15, tip:"Motivo correcto en CRM."}
        ];

        let RAW_DATA=[], FILTERED_DATA=[], timerInterval, seconds=0;

        window.onload = () => { 
            renderFormTable(); 
            initFormLogic(); 
            document.getElementById('auditTools').classList.remove('hidden'); 
            document.getElementById('audioDock').classList.remove('hidden'); 
            
            // ACTUALIZACI√ìN FOOTER CON MAILTO
            const footer = document.querySelector('footer p');
            if(footer) footer.innerHTML = `Desarrollado por <a href="mailto:marco.lara.vera@gmail.com" class="text-indigo-400 hover:text-indigo-300 hover:underline transition">Marco Lara</a> ‚Ä¢ Iniciativa de innovaci√≥n 2026`;
            
            cambiarTab('tabDashboard'); 
        };

        function initFormLogic() {
            const dl = document.getElementById('lista-ejecutivos'); dl.innerHTML = "";
            baseEjecutivos.forEach(e => { let o=document.createElement('option'); o.value=e.nombre; dl.appendChild(o); });
            document.getElementById('inputNombre').addEventListener('input', function() {
                const f = baseEjecutivos.find(e => e.nombre === this.value);
                if(f) { document.getElementById('inputCodigo').value=f.codigo; document.getElementById('inputSup').value=f.sup; document.getElementById('inputServ').value=f.serv; }
            });
        }

        // --- FUNCIONES CORE ---
        function toggleDock(dockId, btnId) { const d=document.getElementById(dockId), b=document.getElementById(btnId); if(d.classList.contains('hidden')){d.classList.remove('hidden');b.classList.add('hidden');}else{d.classList.add('hidden');b.classList.remove('hidden');} }
        function loadAudioFromForm() { const url = document.getElementById('inputAudioUrl').value; if(!url) return Swal.fire("Atenci√≥n", "Pega un link primero", "warning"); const p=document.getElementById('mainAudioPlayer'); p.src=url; p.play(); }
        function setSpeed(rate) { document.getElementById('mainAudioPlayer').playbackRate = rate; }
        function startTimer() { if(!timerInterval) timerInterval=setInterval(()=>{seconds++; let d=new Date(seconds*1000).toISOString().substr(14,5); document.getElementById('timerDisplay').innerText=d;},1000); }
        function pauseTimer() { clearInterval(timerInterval); timerInterval=null; }
        function resetTimer() { pauseTimer(); seconds=0; document.getElementById('timerDisplay').innerText="00:00"; }
        function countUp(id) { const e=document.getElementById(id); e.innerText=parseInt(e.innerText)+1; }
        function countReset(id) { document.getElementById(id).innerText="0"; }
        function copyNotes() { const t=document.getElementById('tempNotes'); navigator.clipboard.writeText(t.value); }
        function calcSemana() { const f=document.getElementById('fechaLlamada').value; if(f) document.getElementById('inputSemana').value="Semana "+Math.ceil(new Date(f).getDate()/7); }

        function renderFormTable() {
            const tb=document.getElementById('tablaItems'); tb.innerHTML=""; let lc="";
            pautaItems.forEach(i => {
                if(i.cat!==lc){tb.innerHTML+=`<tr><td colspan="4" class="p-2 font-bold text-center ${i.cat==='PEC'?'text-red-600 bg-red-50':'text-blue-600 bg-blue-50'} border-y text-[10px] uppercase">${i.cat}</td></tr>`; lc=i.cat;}
                tb.innerHTML+=`<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-2 relative"><div class="tooltip-container"><span class="font-bold text-slate-700 text-[10px] border-b border-dotted border-slate-400 cursor-help">${i.label}</span><span class="tooltip-text">${i.tip}</span></div></td><td class="p-2 text-center"><select name="${i.name}" class="w-full border rounded p-1 text-[10px] font-bold ${i.cat==='PEC'?'critical':'weighted'}" data-w="${i.w||0}" onchange="updateRow(this)"><option value="">-</option><option value="SI">SI</option><option value="NO">NO</option></select></td><td class="p-2 text-center status-cell">-</td><td class="p-2"><input class="desc-input hidden w-full border border-red-300 rounded p-1 text-[10px]" placeholder="Detalle..."></td></tr>`;
            });
        }
        function updateRow(s) { const r=s.closest('tr'), sc=r.querySelector('.status-cell'), i=r.querySelector('.desc-input'); i.classList.add('hidden'); if(s.value==='SI') sc.innerHTML='<span class="text-emerald-600 font-bold bg-emerald-50 px-1 rounded text-[9px]">OK</span>'; else if(s.value==='NO') { sc.innerHTML='<span class="text-red-600 font-bold bg-red-50 px-1 rounded text-[9px]">NO</span>'; i.classList.remove('hidden'); i.focus(); } else sc.innerHTML='-'; calcScore(); }
        function calcScore() { let t=0,m=0,c=false; document.querySelectorAll('.critical').forEach(s=>{if(s.value==='NO')c=true}); document.querySelectorAll('.weighted').forEach(s=>{const w=parseFloat(s.dataset.w);if(s.value==='SI'){t+=w;m+=w}else if(s.value==='NO')m+=w}); const f=(!c && m>0)?Math.round((t/m)*100):(c?0:0); const d=document.getElementById('totalScore'); d.innerText=f+"%"; document.getElementById('notaFinalHidden').value=f+"%"; d.className="font-black text-2xl text-center "+(c||f===0?"text-red-500":(f>=85?"text-emerald-500":"text-yellow-500")); }

        document.getElementById('auditForm').addEventListener('submit',function(e){
            e.preventDefault(); const b=document.getElementById('btnGuardar'), ot=b.innerHTML;
            if(!document.getElementById('inputCodigo').value) return Swal.fire("Error","Selecciona ejecutivo","warning");
            b.innerHTML='GUARDANDO...'; b.disabled=true;
            document.getElementById('fechaAuditoria').value=new Date().toISOString().split('T')[0];
            let obs=document.querySelector('[name="comentario"]').value, errs="";
            document.querySelectorAll('.desc-input').forEach(i=>{if(i.value)errs+=`\n‚Ä¢ ${i.closest('tr').cells[0].innerText}: ${i.value}`});
            if(errs) document.querySelector('[name="comentario"]').value=obs+"\n--- DETALLE ---"+errs;
            const fd=new FormData(this);
            fetch(API_URL,{method:'POST',body:JSON.stringify(Object.fromEntries(fd)),headers:{'Content-Type':'text/plain'}})
            .then(()=>{Swal.fire("Listo","Guardado","success");this.reset();document.getElementById('totalScore').innerText="0%";resetTimer();b.innerHTML=ot;b.disabled=false;loadData();})
            .catch(()=>{Swal.fire("Error","Fallo conexi√≥n","error");b.innerHTML=ot;b.disabled=false;});
        });

        function cambiarTab(id){
            ['tabIngreso','tabDashboard','tabApelaciones'].forEach(t=>document.getElementById(t).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const showDocks = (id === 'tabIngreso');
            document.getElementById('auditTools').classList.toggle('hidden', !showDocks);
            document.getElementById('audioDock').classList.toggle('hidden', !showDocks);
            if(!showDocks) { document.getElementById('openToolsBtn').classList.add('hidden'); document.getElementById('openAudioBtn').classList.add('hidden'); }
            ['navBtnIngreso', 'navBtnDash', 'navBtnApel'].forEach(b => { document.getElementById(b).classList.remove('active-tab'); document.getElementById(b).classList.add('opacity-60'); });
            const activeBtn = id === 'tabIngreso' ? 'navBtnIngreso' : (id === 'tabDashboard' ? 'navBtnDash' : 'navBtnApel');
            const elActive = document.getElementById(activeBtn); elActive.classList.add('active-tab'); elActive.classList.remove('opacity-60');
            if(id==='tabDashboard' || id==='tabApelaciones') { if(RAW_DATA.length > 0) { aplicarFiltros(); renderApelaciones(RAW_DATA); } else { loadData(); } }
        }

        async function loadData() {
            const loader = document.getElementById('loadingIndicator'); if(loader) loader.classList.remove('hidden');
            let data = await intentarFetch("https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(API_URL + "?t=" + Date.now()));
            if (!data) data = await intentarFetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(API_URL + "?t=" + Date.now()));
            if (!data) data = await intentarFetch("https://corsproxy.io/?" + encodeURIComponent(API_URL + "?t=" + Date.now()));

            if(Array.isArray(data)) {
                RAW_DATA = data;
                fillSelects(RAW_DATA); aplicarFiltros(); renderApelaciones(RAW_DATA);
            } else { Swal.fire({icon: 'error', title: 'Error', text: 'No se pudo conectar a la base de datos (Bloqueo de Red).'}); }
            if(loader) loader.classList.add('hidden');
        }
        async function intentarFetch(url) { try { const resp = await fetch(url); if (!resp.ok) return null; const json = await resp.json(); return Array.isArray(json) ? json : null; } catch (e) { return null; } }

        function fillSelects(data){
            const mS=document.getElementById('fMes'), sP=document.getElementById('fSup'), sV=document.getElementById('fServ');
            const saveM=mS.value; 
            mS.innerHTML='<option value="TODOS">üìÖ Hist√≥rico</option>'; sP.innerHTML='<option value="TODOS">Todos</option>'; sV.innerHTML='<option value="TODOS">Todos</option>';
            const ms=new Set(), sp=new Set(), sv=new Set();
            data.forEach(d=>{ let f=d.FECHA_LLAMADA||d.FECHA; if(f&&f.length>=7)ms.add(f.substring(0,7)); sp.add(d.SUPERVISOR); sv.add(d.SERVICIO); });
            Array.from(ms).sort().reverse().forEach(m=>{ mS.add(new Option(`üìÖ ${m}`,m)); const sems=new Set(); data.filter(d=>(d.FECHA_LLAMADA||d.FECHA).startsWith(m)).forEach(d=>sems.add(d.SEMANA)); Array.from(sems).sort().forEach(s=>mS.add(new Option(`‚Ü≥ ${s}`,`${m}|${s}`))); });
            Array.from(sp).sort().forEach(s=>sP.add(new Option(s,s))); Array.from(sv).sort().forEach(s=>sV.add(new Option(s,s)));
            if(saveM) mS.value = saveM;
        }

        function aplicarFiltros(){
            const fm=document.getElementById('fMes').value, fsp=document.getElementById('fSup').value, fsv=document.getElementById('fServ').value, fs=document.getElementById('fSearch').value.toLowerCase();
            document.getElementById('lblPeriodoCobertura').innerText = fm !== "TODOS" ? (fm.includes('|') ? `Filtrado: ${fm.split('|')[0]} - ${fm.split('|')[1]}` : `Filtrado: ${fm}`) : "Todo el Historial";
            FILTERED_DATA=RAW_DATA.filter(d=>{
                let f=d.FECHA_LLAMADA||d.FECHA;
                if(fm!=='TODOS'){ if(fm.includes('|')){const[m,s]=fm.split('|');if(!f.startsWith(m)||d.SEMANA!==s)return false}else if(!f.startsWith(fm))return false }
                if(fsp!=='TODOS'&&d.SUPERVISOR!==fsp)return false; if(fsv!=='TODOS'&&d.SERVICIO!==fsv)return false; if(fs&&!d.NOMBRE.toLowerCase().includes(fs))return false; return true;
            });
            renderDash();
        }
        function resetFiltros(){ document.getElementById('fMes').value='TODOS'; document.getElementById('fSup').value='TODOS'; document.getElementById('fServ').value='TODOS'; document.getElementById('fSearch').value=''; aplicarFiltros(); }

        function renderDash(){
            const d=FILTERED_DATA;
            // 1. Sups
            const sMap={}; d.forEach(x=>{if(!sMap[x.SUPERVISOR])sMap[x.SUPERVISOR]={t:0,g:0,p:0,pc:0,f:0}; let n=parseFloat(x.NOTA.replace('%',''))||0; sMap[x.SUPERVISOR].t++; sMap[x.SUPERVISOR].g+=n; if(n>0){sMap[x.SUPERVISOR].p+=n;sMap[x.SUPERVISOR].pc++} if(x.FEEDBACK_STATUS==='REALIZADO')sMap[x.SUPERVISOR].f++});
            const sc=document.getElementById('supervisorCards'); sc.innerHTML="";
            Object.keys(sMap).forEach(k=>{
                let v=sMap[k];
                let gen = v.t?(v.g/v.t).toFixed(0):0; let penc = v.pc?(v.p/v.pc).toFixed(0):0; let feed = v.t?((v.f/v.t)*100).toFixed(0):0;
                let colGen = gen >= 85 ? 'text-emerald-600' : 'text-red-600'; let colPenc = penc >= 85 ? 'text-emerald-600' : 'text-red-600';
                sc.innerHTML+=`<div class="bg-white p-5 rounded-2xl shadow border border-slate-200 hover:shadow-lg transition"><h4 class="font-black text-sm text-slate-700 border-b border-slate-100 pb-2 mb-3">${k}</h4><div class="grid grid-cols-3 gap-2 text-center text-xs"><div><p class="text-slate-400 font-bold uppercase text-[9px]">General</p><p class="text-2xl font-black ${colGen}">${gen}%</p></div><div class="border-x border-slate-100"><p class="text-slate-400 font-bold uppercase text-[9px]">PENC</p><p class="text-2xl font-black ${colPenc}">${penc}%</p></div><div><p class="text-slate-400 font-bold uppercase text-[9px]">Feed</p><p class="text-2xl font-black text-purple-500">${feed}%</p></div></div></div>`;
            });
            
            // 2. Exec Table
            const eMap={}; baseEjecutivos.forEach(e=>eMap[e.nombre]={n:e.nombre,s:e.sup,sv:e.serv,c:0});
            d.forEach(x=>{if(eMap[x.NOMBRE])eMap[x.NOMBRE].c++});
            let arr=Object.values(eMap);
            const fSup=document.getElementById('fSup').value, fServ=document.getElementById('fServ').value, fSearch=document.getElementById('fSearch').value.toLowerCase();
            if(fSup!=='TODOS') arr=arr.filter(x=>x.s===fSup); if(fServ!=='TODOS') arr=arr.filter(x=>x.sv===fServ); if(fSearch) arr=arr.filter(x=>x.n.toLowerCase().includes(fSearch));
            arr.sort((a,b)=>a.c-b.c);
            const tb=document.getElementById('execSummaryTable'); tb.innerHTML="";
            arr.forEach(x=>{ const cClass = x.c===0 ? "text-red-500 bg-red-50" : "text-slate-700"; tb.innerHTML+=`<tr class="border-b border-slate-100 hover:bg-slate-50 transition"><td class="p-2 font-bold">${x.n}</td><td class="p-2 text-[10px]">${x.s}</td><td class="p-2 text-[10px]">${x.sv}</td><td class="p-2 text-center font-black ${cClass}">${x.c}</td></tr>`; });

            // 3. KPIs Globales
            const ns=d.map(x=>parseFloat(x.NOTA.replace('%',''))||0);
            const promGen = ns.length ? (ns.reduce((a,b)=>a+b,0)/ns.length).toFixed(0) : 0;
            const colPromGen = promGen >= 85 ? 'text-emerald-700' : 'text-red-600';
            document.getElementById('kpiTotal').innerText=ns.length;
            const kpiGenEl = document.getElementById('kpiGeneral'); kpiGenEl.innerText = promGen + "%"; kpiGenEl.className = `text-xl font-black ${colPromGen}`;
            document.getElementById('kpiPenc').innerText=(ns.filter(n=>n>0).length?ns.filter(n=>n>0).reduce((a,b)=>a+b,0)/ns.filter(n=>n>0).length:0).toFixed(0)+"%";
            document.getElementById('kpiCountPec').innerText=ns.filter(n=>n===0).length;
            document.getElementById('kpiFeedback').innerText=d.filter(x=>x.FEEDBACK_STATUS==='REALIZADO').length;
            document.getElementById('kpiApel').innerText=d.filter(x=>x.APELACION_ESTADO!=="").length;

            // 4. TOPS y QUIEBRES (Corregido con Nombres Reales)
            let pencErrors = 0;
            let pecCounts = {};
            let pencCounts = {};

            d.forEach(x => {
                if(x.DETALLE) {
                    for(const [k, v] of Object.entries(x.DETALLE)) {
                        if(v === 'NO') {
                            // Detectar Categor√≠a por prefijo t√©cnico
                            const isPec = ["SEG_", "COND_", "OP_", "SIST_"].some(pre => k.startsWith(pre));
                            // Traducir nombre
                            const nombreReal = INDICADORES_MAP[k] || k;
                            
                            if(isPec) {
                                pecCounts[nombreReal] = (pecCounts[nombreReal] || 0) + 1;
                            } else {
                                pencCounts[nombreReal] = (pencCounts[nombreReal] || 0) + 1;
                                pencErrors++;
                            }
                        }
                    }
                }
            });
            document.getElementById('kpiCountPenc').innerText = pencErrors;
            renderTopList('listTopPec', pecCounts, 'text-red-600', 'bg-red-50');
            renderTopList('listTopPenc', pencCounts, 'text-orange-600', 'bg-orange-50');
            renderTable();
        }

        function renderTopList(elementId, countsObj, textClass, bgClass) {
            const ul = document.getElementById(elementId); ul.innerHTML = "";
            const sorted = Object.entries(countsObj).sort((a, b) => b[1] - a[1]).slice(0, 5);
            if(sorted.length === 0) { ul.innerHTML = "<li class='text-slate-400 italic text-center'>Sin datos</li>"; return; }
            sorted.forEach(([key, count]) => { ul.innerHTML += `<li class="flex justify-between items-center border-b border-slate-100 pb-1 last:border-0"><span class="font-bold text-[10px] text-slate-600 truncate w-3/4" title="${key}">${key}</span><span class="${bgClass} ${textClass} px-2 py-0.5 rounded-full font-black text-[10px]">${count}</span></li>`; });
        }

        function renderTable(){
            const tb=document.getElementById('mainTable'); tb.innerHTML="";
            FILTERED_DATA.forEach(d=>{
                const n = parseFloat(d.NOTA.replace('%',''));
                const col = n >= 85 ? 'text-emerald-600' : (n===0 ? 'text-red-600' : 'text-amber-600');
                tb.innerHTML+=`<tr class="hover:bg-slate-50 border-b border-slate-100 cursor-pointer group" onclick='showDetail(${JSON.stringify(d).replace(/'/g,"&#39;")})'><td class="p-2 text-[10px] text-slate-400">${d.CODIGO}</td><td class="p-2 font-bold text-slate-700">${d.NOMBRE}</td><td class="p-2 text-[10px]">${d.SUPERVISOR}</td><td class="p-2 text-[10px] font-mono">${d.FECHA_LLAMADA||d.FECHA}</td><td class="p-2 text-[10px]">${d.SEMANA}</td><td class="p-2 text-[10px]">${d.SERVICIO}</td><td class="p-2 text-center font-black ${col}">${d.NOTA}</td><td class="p-2 text-center text-[10px]">${d.FEEDBACK_STATUS==='REALIZADO'?'‚úÖ':'‚è≥'}</td><td class="p-2 text-center"><i class="fas fa-eye text-slate-300 group-hover:text-indigo-500 transition"></i></td></tr>`;
            });
        }

        // --- DETALLE FULL ---
        function showDetail(d){
            let itemsHtml = "";
            let tieneQuiebres = false;

            if(d.DETALLE) {
                Object.entries(d.DETALLE).forEach(([k,v])=>{
                    if(v==='NO') {
                        tieneQuiebres = true;
                        const isPec = ["SEG_", "COND_", "OP_", "SIST_"].some(pre => k.startsWith(pre));
                        const nombreReal = INDICADORES_MAP[k] || k;
                        const badge = isPec ? '<span class="bg-red-100 text-red-600 px-1 rounded text-[9px] font-bold">PEC</span>' : '<span class="bg-orange-100 text-orange-600 px-1 rounded text-[9px] font-bold">PENC</span>';
                        
                        // Extraer observaci√≥n espec√≠fica
                        let safeName = nombreReal.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        let regex = new RegExp(`‚Ä¢\\s*${safeName}.*?:\\s*(.*?)(?:\\n|$)`, 'i');
                        let match = d.OBS.match(regex);
                        let obsSpec = match && match[1].trim() ? `<div class="mt-1 text-[10px] text-slate-500 italic pl-2 border-l border-slate-300">"${match[1].trim()}"</div>` : '';

                        itemsHtml += `<li class="text-xs text-slate-600 mb-2 border-b border-slate-50 pb-2"><div class="flex items-center justify-between"><span>${nombreReal}</span> ${badge}</div>${obsSpec}</li>`;
                    }
                });
            }
            if(!tieneQuiebres) itemsHtml = '<li class="text-emerald-500 italic text-center py-2">‚ú® Felicitaciones, sin errores.</li>';

            // Audio Player
            let audioSection = "";
            if (d.AUDIO_URL && d.AUDIO_URL.length > 5) {
                audioSection = `<div class="bg-slate-100 p-2 rounded border border-slate-200 mb-3"><p class="text-[9px] font-bold text-slate-400 uppercase mb-1"><i class="fas fa-play-circle"></i> Audio Llamada</p><audio controls src="${d.AUDIO_URL}" class="w-full h-8"></audio></div>`;
            } else {
                audioSection = `<div class="bg-gray-50 p-2 rounded border border-gray-200 mb-3 text-center text-xs text-gray-400 italic">Audio no disponible</div>`;
            }

            // Feedback
            let feedHtml = d.FEEDBACK_STATUS === 'REALIZADO' ? `<div class="mt-3 bg-indigo-50 p-2 rounded border border-indigo-100"><p class="text-[9px] font-bold text-indigo-500 uppercase mb-1"><i class="fas fa-check-circle"></i> Feedback Realizado</p><p class="text-xs text-indigo-800 italic">"${d.FEEDBACK_TXT || ''}"</p></div>` : `<div class="mt-3 bg-orange-50 p-2 rounded border border-orange-100 text-center"><p class="text-[10px] font-bold text-orange-500 uppercase">Feedback Pendiente ‚è≥</p></div>`;

            const rutPac = d.RUT_PACIENTE || 'No registrado';

            Swal.fire({
                title: `<div class="text-left"><span class="text-xs text-slate-400 font-normal uppercase block">Detalle Evaluaci√≥n</span>${d.NOMBRE}</div>`,
                html: `
                    <div class="text-left">
                        <div class="flex justify-between items-center mb-4">
                            <div><span class="block text-[9px] font-bold text-slate-400 uppercase">RUT Paciente</span><div class="flex items-center gap-2"><span class="font-mono text-xs font-bold bg-slate-100 px-2 rounded">${rutPac}</span><button onclick="copiarRut('${rutPac}')" class="text-indigo-500 hover:text-indigo-700" title="Copiar"><i class="fas fa-copy"></i></button></div></div>
                            <div class="text-right"><span class="text-6xl font-black ${parseFloat(d.NOTA)>=85?'text-emerald-500':(parseFloat(d.NOTA)===0?'text-red-500':'text-amber-500')} tracking-tighter leading-none">${d.NOTA}</span><span class="block text-[9px] text-slate-300 font-bold uppercase">Nota Final</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-[10px] bg-slate-50 p-2 rounded mb-3 border border-slate-100">
                            <div><span class="font-bold text-slate-400">Fecha:</span> ${d.FECHA_LLAMADA||d.FECHA} ${d.HORA_LLAMADA||''}</div>
                            <div><span class="font-bold text-slate-400">Semana:</span> ${d.SEMANA}</div>
                            <div><span class="font-bold text-slate-400">Auditor:</span> ${d.AUDITOR_REAL || d.AUDITOR || 'Admin'}</div>
                            <div><span class="font-bold text-slate-400">Supervisor:</span> ${d.SUPERVISOR}</div>
                        </div>
                        ${audioSection}
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Observaci√≥n General</p>
                        <div class="text-xs bg-slate-50 p-2 italic mb-3 border border-slate-100 rounded text-slate-600">"${d.OBS.split('---')[0]}"</div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Detalle Quiebres</p>
                        <ul class="max-h-32 overflow-y-auto pr-1 mb-2 custom-scrollbar">${itemsHtml}</ul>
                        ${feedHtml}
                    </div>`,
                width: '550px', showCloseButton: true, showConfirmButton: false, customClass: { popup: 'rounded-2xl' }
            });
        }

        function copiarRut(rut) { navigator.clipboard.writeText(rut).then(() => Swal.showValidationMessage('RUT Copiado')); }

        function renderApelaciones(data) {
            const cont = document.getElementById('contApelaciones');
            const apels = data.filter(d => d.APELACION_ESTADO && d.APELACION_ESTADO !== "");
            cont.innerHTML = "";
            if(apels.length === 0) { cont.innerHTML = `<div class="text-center py-10 bg-white rounded-xl border border-slate-200"><i class="fas fa-check-circle text-4xl text-emerald-200 mb-2"></i><p class="text-slate-400 font-bold text-sm">No hay apelaciones pendientes.</p></div>`; return; }
            apels.forEach(d => {
                const isPend = d.APELACION_ESTADO === 'PENDIENTE';
                const statusBadge = isPend ? '<span class="bg-pink-100 text-pink-600 px-2 py-1 rounded text-[10px] font-bold animate-pulse">PENDIENTE</span>' : `<span class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-[10px] font-bold">${d.APELACION_ESTADO}</span>`;
                cont.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 ${isPend ? 'border-pink-500' : 'border-slate-300'} relative"><div class="flex justify-between items-start mb-3"><div><h4 class="font-bold text-slate-700">${d.NOMBRE}</h4><p class="text-[10px] text-slate-400 uppercase font-bold">${d.FECHA_LLAMADA} ‚Ä¢ Nota: ${d.NOTA}</p></div>${statusBadge}</div><div class="bg-pink-50 p-3 rounded-lg border border-pink-100 mb-3"><p class="text-[10px] font-bold text-pink-400 uppercase mb-1"><i class="fas fa-comment-alt"></i> Argumento:</p><p class="text-xs text-slate-700 italic">"${d.APELACION_TXT}"</p></div><div class="flex justify-end gap-2"><button onclick="showDetail(${JSON.stringify(d).replace(/'/g,"&#39;")})" class="text-xs text-slate-500 font-bold px-3 py-2 bg-slate-50 rounded border hover:bg-slate-100">Ver Auditor√≠a</button>${isPend ? `<a href="https://wa.me/?text=Hola ${d.NOMBRE}, sobre tu apelaci√≥n..." target="_blank" class="text-xs bg-emerald-500 text-white font-bold px-3 py-2 rounded hover:bg-emerald-600 flex items-center gap-2"><i class="fab fa-whatsapp"></i> Responder</a>` : ''}</div></div>`;
            });
        }

        function exportarExcel() { 
            const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(FILTERED_DATA); XLSX.utils.book_append_sheet(wb, ws, "Reporte_QA"); XLSX.writeFile(wb, "Reporte_Calidad.xlsx");
        }
    </script>
</body>
</html>
